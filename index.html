<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CBT SMAN 1 Warunggunung</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI',sans-serif}
  body,html{background:#000;color:#fff;height:100vh;width:100vw;overflow:hidden;position:fixed}
  #loginPage{position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:10;padding:20px}
  #loginPage img{width:90px;height:90px;border-radius:50%;border:0px solid rgba(255,255,255,.3);margin-bottom:20px}
  #loginPage input{width:90%;max-width:340px;padding:16px;margin:10px 0;border:none;border-radius:12px;font-size:18px}
  #loginPage button{width:90%;max-width:340px;padding:16px;background:#27ae60;color:#fff;border:none;border-radius:12px;font-size:19px;font-weight:bold;cursor:pointer}
  #lockScreen{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(231,76,60,0.98);display:none;flex-direction:column;justify-content:center;align-items:center;z-index:99999;text-align:center;padding:20px}
  #lockScreen h1{font-size:60px;margin:20px}
  #lockScreen p{font-size:20px;line-height:1.6}
  #tokenBtn {
  position: fixed;
  top: 15px;
  right: 20px;                 /* ← pindah ke kanan */
  left: auto;                  /* ← hapus left:50% */
  transform: none;             /* ← hapus transform */
  background: rgba(0,0,0,1);
  color: black;
  width: 30px;
  height: 30px;
  padding: 0;                  /* ← karena sudah pakai width/height */
  border-radius: 50%;
  font-size: 20px;
  cursor: pointer;
  z-index: 999999;
  display: none;
  align-items: center;
  justify-content: center;
  box-shadow: 0 6px 25px rgba(0,0,0,0.4);
  border: 0px solid black;
  transition: all 0.3s ease;
  }
  #tokenBtn:hover {
  background: #e74c3c;
  color: white;
  transform: scale(1.1);
  }
  #tokenModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;color:#000;padding:30px;border-radius:20px;width:90%;max-width:380px;display:none;z-index:999999;text-align:center;box-shadow:0 10px 40px rgba(0,0,0,0.7)}
  #tokenModal input{width:100%;padding:15px;margin:15px 0;border:2px solid #ddd;border-radius:10px;font-size:18px}
  #tokenModal button{padding:12px 30px;background:#27ae60;color:#fff;border:none;border-radius:10px;margin:5px;cursor:pointer;font-weight:bold}
  #dash{display:none;width:100%;height:100vh;background:#fff;color:#000;overflow-y:auto}
  .header{background:linear-gradient(45deg,#2ecc71,#27ae60);padding:30px 20px;text-align:center;color:#fff}
  .header img{width:80px;height:80px;border-radius:50%;border:0px solid rgba(255,255,255,.3)}
  #mainTimer{background:#e74c3c;color:#fff;padding:12px 25px;border-radius:50px;font-size:24px;font-weight:bold;margin:15px auto;width:90%;max-width:400px;display:none}
  .menu-item{margin:15px;border-radius:15px;overflow:hidden;background:#f8f9fa;box-shadow:0 6px 20px rgba(0,0,0,.1)}
  .hari-btn{padding:18px;display:flex;justify-content:space-between;align-items:center;font-size:19px;font-weight:bold;cursor:pointer;background:#fff}
  .hari-btn i{transition:.3s}
  .hari-btn.active i{transform:rotate(180deg)}
  .submenu{max-height:0;overflow:hidden;transition:max-height .6s ease;background:#fff}
  .submenu.active{max-height:3000px;padding:10px 0}
  .submenu button{width:100%;padding:16px;border:none;color:#fff;font-weight:600;cursor:pointer;margin:5px 0;background:linear-gradient(45deg,#ff6b6b,#ee5a52);box-shadow:0 4px 12px rgba(0,0,0,.2)}
  .submenu button:nth-child(2){background:linear-gradient(45deg,#4ecdc4,#44a49a)}
  .submenu button:nth-child(3){background:linear-gradient(45deg,#a29bfe,#6c5ce7)}
  .countdown{font-size:13px;margin-top:5px;color:#fff}
  #iframeContainer{height:calc(100vh - 300px);margin:20px;border-radius:15px;overflow:hidden;box-shadow:0 10px 30px rgba(0,0,0,.2);display:none}
  iframe{width:100%;height:100%;border:none}
  .loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);display:flex;justify-content:center;align-items:center;z-index:9999}
  .spinner{width:60px;height:60px;border:8px solid rgba(255,255,255,.3);border-top:8px solid #fff;border-radius:50%;animation:s 1s linear infinite}
  @keyframes s{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<div class="loading" id="loading"><div class="spinner"></div></div>

<!-- LOGIN -->
<div id="loginPage">
  <img src="https://i.imgur.com/pckiPOg.png" alt="Logo">
  <h1>CBT Online</h1>
  <p>SMAN 1 WARUNGGUNUNG</p>
  <input type="text" id="nis" placeholder="Username">
  <input type="password" id="pass" placeholder="Password">
  <button onclick="login()">MASUK UJIAN</button>
  <p style="center">MonteaBaok Dev@2025<p>
</div>

<!-- IKON KUNCI + TOKEN -->
<div id="tokenBtn" onclick="bukaToken()"></div>
<div id="tokenModal">
  <h2>Token Keluar</h2>
  <input type="password" id="tokenInput" placeholder="Masukkan token MonteaBaok">
  <button onclick="cekToken()">KELUAR</button>
  <button onclick="document.getElementById('tokenModal').style.display='none'">Batal</button>
</div>

<!-- LAYAR KUNCI CURANG -->
<div id="lockScreen">
  <h1>CURANG!</h1>
  <p>Pindah aplikasi, screenshot, atau keluar fullscreen dilarang!</p>
  <p style="margin-top:30px;font-size:18px">Pengawas: Klik ikon kunci di atas</p>
</div>

<!-- DASHBOARD -->
<div id="dash">
  <div class="header">
    <img src="https://i.imgur.com/pckiPOg.png" alt="Logo">
    <h1 id="nama">-</h1>
    <p>Kelas <span id="kelas">-</span></p>
    <div id="mainTimer">Memuat...</div>
  </div>
  <div id="menu"></div>
  <div id="iframeContainer"><iframe id="formIframe" src=""></iframe></div>
</div>

<script>
// GANTI INI SAJA
const SPREADSHEET_ID = '1aKrniQrr-si5tcQo5g4l1GNYr-WC1Rt7JYYQpBv7jGM';
const TOKEN_KELUAR = "MonteaBaok2025"; // ← Token rahasia pengawas

const SHEET_SISWA = 'DataSiswa';
const SHEET_JADWAL = 'JadwalSoal';
let siswaDB = [], jadwalDB = [], currentEndTime = 0;
let lockdown = false;

Promise.all([
  fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_SISWA}`),
  fetch(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:json&sheet=${SHEET_JADWAL}`)
]).then(r => Promise.all(r.map(x => x.text()))).then(([t1,t2]) => {
  siswaDB = JSON.parse(t1.substr(47).slice(0,-2)).table.rows.map(r=>r.c);
  jadwalDB = JSON.parse(t2.substr(47).slice(0,-2)).table.rows.map(r=>r.c);
  document.getElementById('loading').style.display = 'none';
});

function login() {
  const user = siswaDB.find(r => r[0]?.v == document.getElementById('nis').value.trim() && r[1]?.v == document.getElementById('pass').value);
  if (user) {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('dash').style.display = 'block';
    document.getElementById('nama').textContent = user[2].v;
    document.getElementById('kelas').textContent = user[3].v;
    renderDashboard(user[3].v);
    aktifkanLockdown();
    setInterval(() => renderDashboard(user[3].v), 5000);
  } else alert('NIS atau Password salah!');
}

function renderDashboard(kelasSiswa) {
  const container = document.getElementById('menu'); container.innerHTML = '';
  const grupHari = {};
  jadwalDB.forEach(row => {
    const hari = row[0]?.v || '';
    const daftarKelas = (row[1]?.v||'').replace(/sampai|sd/gi,',').split(',').map(k=>k.trim());
    const mapel = row[2]?.v || '';
    const link = row[3]?.v || '#';
    const mulai = row[4]?.v || ''; const selesai = row[5]?.v || '';
    const aktif = (row[6]?.v||'').toLowerCase() === 'ya';
    if (daftarKelas.includes(kelasSiswa) && aktif) {
      const jamSekarang = new Date().getHours()*60 + new Date().getMinutes();
      const jamMulai = parseInt(mulai.split(':')[0])*60 + parseInt(mulai.split(':')[1]||0);
      const jamSelesai = parseInt(selesai.split(':')[0])*60 + parseInt(selesai.split(':')[1]||0);
      if (jamSekarang >= jamMulai && jamSekarang <= jamSelesai) {
        if (!grupHari[hari]) grupHari[hari] = [];
        grupHari[hari].push({mapel, link, selesai: jamSelesai});
      }
    }
  });

  Object.keys(grupHari).sort().forEach((hari, idx) => {
    const div = document.createElement('div'); div.className = 'menu-item';
    div.innerHTML = `<div class="hari-btn" onclick="this.classList.toggle('active');this.nextElementSibling.classList.toggle('active')"><span>${hari}</span><i class="fa fa-chevron-down"></i></div><div class="submenu"></div>`;
    const sub = div.querySelector('.submenu');
    grupHari[hari].forEach((u,i) => {
      const btn = document.createElement('button');
      btn.textContent = u.mapel;
      btn.onclick = () => showInIframe(u.link, u.selesai);
      btn.innerHTML += `<div class="countdown" id="cd${idx}${i}"></div>`;
      sub.appendChild(btn);
      hitungMundurKecil(`cd${idx}${i}`, u.selesai);
    });
    container.appendChild(div);
  });
}

function showInIframe(url, endMinutes) {
  document.getElementById('iframeContainer').style.display = 'block';
  document.getElementById('formIframe').src = url;
  currentEndTime = endMinutes;
  document.getElementById('mainTimer').style.display = 'block';
  startMainTimer();
}

function startMainTimer() {
  clearInterval(window.mainTimer);
  window.mainTimer = setInterval(() => {
    const sisa = currentEndTime - (new Date().getHours()*60 + new Date().getMinutes());
    if (sisa <= 0) { clearInterval(window.mainTimer); document.getElementById('mainTimer').textContent = 'WAKTU HABIS!'; document.getElementById('iframeContainer').style.display = 'none'; document.getElementById('formIframe').src = ''; return; }
    const h = String(Math.floor(sisa/60)).padStart(2,'0');
    const m = String(sisa%60).padStart(2,'0');
    document.getElementById('mainTimer').textContent = `Sisa: ${h}:${m}`;
  }, 1000);
}

function hitungMundurKecil(id, menitSelesai) {
  setInterval(() => {
    const sisa = menitSelesai - (new Date().getHours()*60 + new Date().getMinutes());
    document.getElementById(id).textContent = sisa <= 0 ? 'Waktu Habis' : `Sisa: ${String(Math.floor(sisa/60)).padStart(2,'0')}:${String(sisa%60).padStart(2,'0')}`;
  }, 1000);
}

// ANTI-CURANG KHUSUS PONSEL
function aktifkanLockdown() {
  lockdown = true;
  document.documentElement.requestFullscreen();
  document.getElementById('tokenBtn').style.display = 'block';

  // 1. FULLSCREEN WAJIB
  const masukFullscreen = () => {
    if (!document.fullscreenElement) {
      document.documentElement.requestFullscreen().catch(() => {});
    }
  };
  masukFullscreen();
  document.addEventListener('fullscreenchange', () => {
    if (!document.fullscreenElement) kunci();
  });

  // 2. BLOKIR TOMBOL BACK & HOME (ANDROID) — INI YANG PALING PENTING!
  let backButtonCount = 0;
  document.addEventListener('backbutton', (e) => {
    e.preventDefault();
    e.stopPropagation();
    kunci();
  }, false);

  // 3. BLOKIR SWIPE NOTIFIKASI DARI ATAS
  let lastTouchY = 0;
  let touchStartTime = 0;
  document.addEventListener('touchstart', (e) => {
    lastTouchY = e.touches[0].clientY;
    touchStartTime = Date.now();
  }, { passive: false });

  document.addEventListener('touchmove', (e) => {
    const currentY = e.touches[0].clientY;
    const deltaY = currentY - lastTouchY;
    const deltaTime = Date.now() - touchStartTime;

    // Jika swipe dari atas ke bawah cepat (tarik notifikasi/status bar)
    if (lastTouchY < 50 && deltaY > 50 && deltaTime < 300) {
      e.preventDefault();
      kunci();
    }
  }, { passive: false });

  // 4. BLOKIR TOMBOL RECENT APPS (Android) — PAKAI TRIK INI
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      setTimeout(() => {
        if (document.hidden) kunci();
      }, 300);
    }
  });

  // 5. BLOKIR KLIK KANAN & SHORTCUT LAIN
  document.oncontextmenu = () => false;
  document.onkeydown = (e) => {
    if (e.key === "Escape" || e.ctrlKey || e.altKey || e.key === "Backspace") {
      e.preventDefault();
      kunci();
    }
  };

  // 6. CEK SETIAP DETIK — KALAU KELUAR FULLSCREEN LANGSUNG KUNCI
  setInterval(() => {
    if (!document.fullscreenElement) kunci();
  }, 500);
}

function kunci() {
  if (!lockdown) return;

  // 1. Layar merah
  document.getElementById('dash').style.display = 'none';
  document.getElementById('lockScreen').style.display = 'flex';

  // 2. GETAR KUAT (meskipun HP silent)
  if (navigator.vibrate) {
    navigator.vibrate([600, 200, 600, 200, 1000]); // getar 5 detik keras
  }

  // 3. BUNYI ALARM SUPER KERAS (pakai frekuensi 1000Hz + 2000Hz bergantian — pasti terdengar walau volume 0!)
  let audioContext = new (window.AudioContext || window.webkitAudioContext)();
  let oscillator = audioContext.createOscillator();
  let gainNode = audioContext.createGain();
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  gainNode.gain.value = 1; // volume maksimal
  oscillator.frequency.value = 1000;
  oscillator.type = 'sine';
  oscillator.start();

  // Ganti nada tiap 0.3 detik biar makin mengganggu
  let freq = 1000;
  setInterval(() => {
    freq = freq === 1000 ? 2000 : 1000;
    oscillator.frequency.setValueAtTime(freq, audioContext.currentTime);
  }, 300);

  // Matikan setelah 12 detik
  setTimeout(() => oscillator.stop(), 12000);
}

function bukaToken() { document.getElementById('tokenModal').style.display = 'block'; }
function cekToken() {
  if(document.getElementById('tokenInput').value === TOKEN_KELUAR) {
    lockdown = false;
    document.getElementById('lockScreen').style.display = 'none';
    document.getElementById('tokenModal').style.display = 'none';
    document.getElementById('tokenBtn').style.display = 'none';
    document.exitFullscreen();
    location.reload();
  } else alert("Token salah!");
}
</script>
</body>
</html>
